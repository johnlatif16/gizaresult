<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8">
<title>لوحة تحكم الادمن</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
body { display: flex; min-height: 100vh; font-family: sans-serif; }
.sidebar { width: 220px; background-color: #1e40af; color: white; padding: 20px; display: flex; flex-direction: column; }
.sidebar button { margin-bottom: 10px; text-align: left; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; }
.sidebar button:hover { background-color: #3b82f6; }
.content { flex-grow: 1; padding: 20px; overflow-x: auto; }
.hidden { display: none; }
table th, table td { text-align: center; padding: 8px; }
table th { background-color: #1e40af; color: white; }
button.action-btn { padding: 5px 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
button.open-btn { background-color: #16a34a; color: white; }
button.open-btn:hover { background-color: #15803d; }
button.send-btn { background-color: #2563eb; color: white; }
button.send-btn:hover { background-color: #1d4ed8; }
img.screenshot { width: 100px; border: 1px solid #ddd; border-radius: 5px; }
</style>
</head>
<body>

<div class="sidebar">
  <button onclick="showSection('requests')">الطلبات</button>
  <button onclick="showSection('results')">النتائج</button>
  <button onclick="showSection('send')">إرسال النتيجة عبر البريد</button>
  <button onclick="logout()">تسجيل الخروج</button>
</div>

<div class="content">
  <!-- طلبات الدفع -->
  <div id="requests" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">طلبات الدفع</h2>
    <table class="min-w-full bg-white rounded-lg shadow">
      <thead>
  <tr>
    <th>الرقم القومي</th>
    <th>رقم الجلوس</th>
    <th>رقم الهاتف</th>
    <th>البريد الإلكتروني</th>
    <th>سكرين التحويل</th>
    <th>تاريخ الطلب</th>
  </tr>
</thead>
<tbody id="requestsTable"></tbody>

    </table>
  </div>

  <!-- النتائج المفتوحة -->
  <div id="results" class="hidden">
    <h2 class="text-2xl font-semibold mb-4">النتائج المفتوحة</h2>
    <table class="min-w-full bg-white rounded-lg shadow">
      <thead>
        <tr>
          <th>رقم الجلوس</th><th>الاسم</th><th>الصف</th><th>المدرسة</th><th>النسبة %</th><th>الملاحظات</th><th>فتح النتيجة</th><th>إرسال البريد</th>
        </tr>
      </thead>
      <tbody id="resultsTable"></tbody>
    </table>
  </div>

  <!-- إرسال البريد -->
  <div id="send" class="hidden max-w-md">
    <h2 class="text-2xl font-semibold mb-4">إرسال النتيجة عبر البريد</h2>
    <form id="sendForm" class="space-y-4">
      <input id="sendSeat" placeholder="رقم الجلوس" required class="w-full p-2 border rounded">
      <input id="sendEmail" placeholder="البريد الإلكتروني" required class="w-full p-2 border rounded">
      <textarea id="sendMessage" placeholder="نص الرسالة" class="w-full p-2 border rounded"></textarea>
      <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">إرسال</button>
    </form>
  </div>
</div>

<script>
function showSection(id){
  ['requests','results','send'].forEach(sec => document.getElementById(sec).classList.add('hidden'));
  document.getElementById(id).classList.remove('hidden');
}

function logout(){ window.location.href = '/login.html'; }

// تحميل الطلبات مع الصور
async function loadRequests(){
  const res = await fetch('/api/results');
  const data = await res.json();
  const tbody = document.getElementById('requestsTable');
  tbody.innerHTML = '';
data.requests.forEach(r => {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${r.nationalId || ''}</td>
    <td>${r.seatNumber}</td>
    <td>${r.phone}</td>
    <td>${r.email}</td>
    <td>${r.screenshot ? `<img class="screenshot" src="/uploads/${r.screenshot}" />` : ''}</td>
    <td>${new Date(r.created_at).toLocaleString()}</td>
  `;
  tbody.appendChild(tr);
});

}

// تحميل النتائج
async function loadResults(){
  const res = await fetch('/api/results');
  const data = await res.json();
  const tbody = document.getElementById('resultsTable');
  tbody.innerHTML = '';
  data.results.forEach(student => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${student.seatNumber}</td>
      <td>${student.name}</td>
      <td>${student.gradeLevel}</td>
      <td>${student.schoolName}</td>
      <td>${student.percentage}</td>
      <td>${student.notes || ''}</td>
      <td><button class="action-btn open-btn" onclick="openResult('${student.seatNumber}')">فتح</button></td>
      <td><button class="action-btn send-btn" onclick="sendEmailPrompt('${student.seatNumber}')">إرسال</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// فتح نتيجة مباشرة
async function openResult(seatNumber){
  const res = await fetch('/api/open-result', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify({seatNumber})
  });
  const data = await res.json();
  alert(data.success ? 'تم فتح النتيجة' : 'خطأ: ' + data.message);
  loadRequests();
  loadResults();
}

// إرسال البريد مباشرة
function sendEmailPrompt(seatNumber){
  const email = prompt('البريد الإلكتروني:');
  if(!email) return alert('البريد الإلكتروني مطلوب');
  const message = prompt('نص الرسالة:');

  fetch('/api/send-email-dashboard',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({seatNumber,email,message})
  }).then(res=>res.json()).then(data=>{
    alert(data.success ? 'تم الإرسال' : 'خطأ: ' + data.message);
  });
}

// فور تحميل الصفحة
loadRequests();
loadResults();

// تحديث دوري كل 10 ثواني
setInterval(()=>{
  loadRequests();
  loadResults();
}, 10000);
</script>

</body>
</html>